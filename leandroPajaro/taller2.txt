drop database informacion_transmilenio;
create database informacion_transmilenio;
use informacion_transmilenio; 
create table gravedad( 
seq_gravedad int primary key,
nom_gravedad varchar(100)
);
create table concesion( 
seq_concesion int primary key,
nom_concesion varchar(100)
);
create table empresa( 
seq_empresa int primary key,
nom_empresa varchar(100)
);
create table tipo_servicio( 
seq_tipo_servicio int primary key,
nom_tipo_servicio varchar(100)
);
create table afectacion( 
seq_afectacion int primary key,
nom_afectacion varchar(100)
);
create table tipo_accidente( 
seq_tipo_accidente int primary key,
Tipo varchar(100)
);
create table vehiculo( 
placa varchar(10) primary key,
fecha date,
modelo varchar(100), 
marca varchar(100), 
tipologia varchar(100),
opera varchar(2),
no_opera varchar(2)
);
create table fecha( 
seq_fecha int primary key,
instante date unique, 
ano varchar(10),
mes varchar (20),
dia varchar(20)
);

create table accidentalidad( 
Id_accidentalidad int primary key,
seq_fecha date,
franja_horaria varchar(20),
r_franja varchar(20),
seq_tipo_accidente int,
seq_afectacion int,
seq_tipo_servicio int,
seq_empresa_operadora int,
concesion int,
linea varchar(10),
ruta varchar(20),
coordenada_X varchar(20),
coordenada_Y varchar(20),
desp_suceso varchar(5000),
num_lesionados_valorados int,
num_lesionados_trasladados int,
num_victimas_fatales int,
gravedad_afectados int,
conciliacion varchar(5),
placa varchar(10),
inmovilizado varchar(20),
sentido varchar(20)
);

alter table accidentalidad add foreign key (seq_fecha) references fecha(instante);

alter table accidentalidad add foreign key (seq_tipo_accidente) references tipo_accidente(seq_tipo_accidente);

alter table accidentalidad add foreign key (seq_afectacion) references afectacion(seq_afectacion);

alter table accidentalidad add foreign key (concesion) references concesion(seq_concesion);

alter table accidentalidad add foreign key (placa) references vehiculo(placa);

alter table accidentalidad add foreign key (gravedad_afectados) references gravedad(seq_gravedad);

alter table accidentalidad add foreign key(seq_empresa_operadora) references empresa(seq_empresa);

alter table accidentalidad add foreign key (seq_tipo_servicio) references tipo_servicio(seq_tipo_servicio);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/gravedad.csv' IGNORE INTO TABLE gravedad CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_gravedad, nom_gravedad);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/concesion.csv' IGNORE INTO TABLE concesion CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_concesion, nom_concesion);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/empresa.csv' IGNORE INTO TABLE empresa CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_empresa, nom_empresa);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/tipoServicio.csv' IGNORE INTO TABLE tipo_servicio CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_tipo_servicio, nom_tipo_servicio);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/afectacion.csv' IGNORE INTO TABLE afectacion CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_afectacion, nom_afectacion);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/tipo_accidente.csv' IGNORE INTO TABLE tipo_accidente CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_tipo_accidente, Tipo);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/vehiculo.csv' IGNORE INTO TABLE vehiculo CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (fecha,placa,tipologia,modelo,marca,opera,no_opera);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/fecha.csv' IGNORE INTO TABLE fecha CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (seq_fecha,instante,ano,mes,dia);

LOAD DATA LOCAL INFILE 'C:/temp/archivos_csv/accidentalidad.csv' IGNORE INTO TABLE accidentalidad CHARACTER SET UTF8 FIELDS TERMINATED BY ';' ENCLOSED BY '"' LINES TERMINATED BY '\r\n' IGNORE 1 LINES (Id_accidentalidad,seq_fecha,franja_horaria,r_franja,seq_tipo_accidente,seq_afectacion,seq_tipo_servicio,seq_empresa_operadora,concesion,linea,ruta,coordenada_X,coordenada_Y,desp_suceso,num_lesionados_valorados,num_lesionados_trasladados,num_victimas_fatales,gravedad_afectados,conciliacion,placa,inmovilizado,sentido);


select f.dia,count(a.seq_tipo_accidente) as Cantidad_accidentes_por_dia
from accidentalidad ac 
inner join fecha f  on ac.seq_fecha = f.instante
inner join tipo_accidente a on ac.seq_tipo_accidente = a.seq_tipo_accidente  
group by  f.dia;

select ac.r_franja,count(a.seq_tipo_accidente) as Cantidad_accidentes_por_franja_Horaria
from accidentalidad ac 
inner join tipo_accidente a on ac.seq_tipo_accidente = a.seq_tipo_accidente  
group by  ac.r_franja;

select a.tipo,count(a.seq_tipo_accidente) as Cantidad_accidnetes_por_tipo
from accidentalidad ac 
inner join tipo_accidente a on ac.seq_tipo_accidente = a.seq_tipo_accidente  
group by  a.tipo;

select emp.nom_empresa , count(af.seq_afectacion) as Cantidad_accidentes_por_empresa
from accidentalidad ac
inner join empresa emp on ac.seq_empresa_operadora = emp.seq_empresa
inner join afectacion af on ac.seq_afectacion = af.seq_afectacion
where af.nom_afectacion = "Accidente"
group by emp.nom_empresa
order by count(af.seq_afectacion) desc;

select ve.marca , count(a.seq_tipo_accidente) as Marca_Vehiculo_mas_Accidente
from accidentalidad ac
inner join vehiculo ve on ac.placa = ve.placa
inner join tipo_accidente a on ac.seq_tipo_accidente = a.seq_tipo_accidente 
group by ve.marca 
order by count(a.seq_tipo_accidente) desc;


select emp.nom_empresa, concesion.nom_concesion, f.dia, tipo.tipo , servicio.nom_tipo_servicio, gravedad.nom_gravedad
from accidentalidad ac 
inner join empresa emp on ac.seq_empresa_operadora = emp.seq_empresa
inner join concesion concesion on ac.concesion = concesion.seq_concesion
inner join fecha f  on ac.seq_fecha = f.instante
inner join tipo_accidente tipo on ac.seq_tipo_accidente = tipo.seq_tipo_accidente  
inner join tipo_servicio servicio on ac.seq_tipo_servicio = servicio.seq_tipo_servicio
inner join gravedad gravedad on ac.gravedad_afectados = gravedad.seq_gravedad
where ac.num_lesionados_trasladados > 0;

select f.dia , emp.nom_empresa ,sum(ac.num_victimas_fatales) as numero_victimas
from accidentalidad ac
inner join empresa emp on ac.seq_empresa_operadora = emp.seq_empresa
inner join fecha f  on ac.seq_fecha = f.instante
where ac.num_victimas_fatales > 0
group by f.dia,emp.nom_empresa;